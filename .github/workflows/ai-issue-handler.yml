name: AI Issue Handler

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      min_upvotes:
        description: 'Minimum upvotes required'
        required: false
        default: '1'
      ai_context:
        description: 'AI context for Copilot'
        required: false
        default: |
          This is a React hook for form management.
          The main file is lib/useForm.ts.
          Follow React best practices and maintain type safety.

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

env:
  MIN_UPVOTES: ${{ github.event.inputs.min_upvotes || vars.DEFAULT_MIN_UPVOTES || 1 }}
  AI_CONTEXT: ${{ github.event.inputs.ai_context || 'Default AI context' }}

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.create-fix-branch.outputs.branch_name }}
      issue_number: ${{ steps.count-upvotes.outputs.issue_number }}
      result: ${{ steps.count-upvotes.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Count upvotes
        id: count-upvotes
        uses: actions/github-script@v6
        with:
          debug: true
          script: |
            try {
              console.log('Context payload:', JSON.stringify(context.payload));
              
              let issueNumber = null;
              if (context.payload.issue) {
                issueNumber = context.payload.issue.number;
              } else if (context.payload.comment) {
                issueNumber = context.payload.comment.issue_number;
              } else {
                console.log('No issue or comment found in payload');
                core.setOutput('result', 'false');
                return false;
              }
              
              console.log(`Fetching issue #${issueNumber}`);
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              console.log(`Issue reactions: ${JSON.stringify(issue.reactions)}`);
              
              const upvotes = issue.reactions ? issue.reactions['+1'] : 0;
              const threshold = parseInt(process.env.MIN_UPVOTES || 1);
              
              console.log(`Upvotes: ${upvotes}, Threshold: ${threshold}`);
              const result = upvotes >= threshold;
              
              core.setOutput('issue_number', issueNumber.toString());
              core.setOutput('result', result.toString());
              return result;
            } catch (error) {
              console.log(`Error details: ${error.stack}`);
              core.setFailed(`Error counting upvotes: ${error.message}`);
              core.setOutput('result', 'false');
              return false;
            }

      - name: Get issue details
        if: steps.count-upvotes.outputs.result == 'true'
        id: get-issue
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = ${{ steps.count-upvotes.outputs.issue_number }};
            
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            console.log(`Issue title: ${issue.title}`);
            console.log(`Issue body: ${issue.body}`);
            
            // Store issue details for other steps
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body);

      - name: Create fix branch
        if: steps.count-upvotes.outputs.result == 'true'
        id: create-fix-branch
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          ISSUE_NUMBER="${{ steps.count-upvotes.outputs.issue_number }}"
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="fix/issue-${ISSUE_NUMBER}-${TIMESTAMP}"
          
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Copilot prompt
        if: steps.count-upvotes.outputs.result == 'true'
        run: |
          mkdir -p .github/copilot
          cat > .github/copilot/prompt.md << EOF
          # Issue to fix: ${{ steps.get-issue.outputs.issue_title }}
          
          ## Issue description
          ${{ steps.get-issue.outputs.issue_body }}
          
          ## Context information
          ${{ env.AI_CONTEXT }}
          
          ## Task
          Based on the above issue, please modify the necessary files to fix the problem.
          Focus on src/lib/useForm.ts as the main hook file.
          EOF

      - name: Apply simulated AI fix
        if: steps.count-upvotes.outputs.result == 'true'
        id: apply-fix
        run: |
          ISSUE_NUMBER="${{ steps.count-upvotes.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.get-issue.outputs.issue_title }}"
          ISSUE_BODY="${{ steps.get-issue.outputs.issue_body }}"
          
          # Check if the target file exists
          if [ -f "src/lib/useForm.ts" ]; then
            FILE_PATH="src/lib/useForm.ts"
          else
            echo "Error: Could not find useForm.ts file"
            exit 1
          fi
          
          # Read the file content
          FILE_CONTENT=$(cat $FILE_PATH)
          
          # Simulate AI fix based on issue keywords
          if [[ "$ISSUE_TITLE $ISSUE_BODY" == *"typescript"* ]] || [[ "$ISSUE_TITLE $ISSUE_BODY" == *"type"* ]]; then
            # Typescript fix
            echo -e "// AI Fix for issue #$ISSUE_NUMBER: $ISSUE_TITLE\n// Improved type safety and error handling\n$FILE_CONTENT" > $FILE_PATH
            echo "Applied TypeScript improvement fix"
          elif [[ "$ISSUE_TITLE $ISSUE_BODY" == *"performance"* ]]; then
            # Performance fix
            echo -e "// AI Fix for issue #$ISSUE_NUMBER: $ISSUE_TITLE\n// Performance optimization\n$FILE_CONTENT" > $FILE_PATH
            echo "Applied performance optimization fix"
          else
            # Generic fix
            echo -e "// AI Fix for issue #$ISSUE_NUMBER: $ISSUE_TITLE\n// This fix addresses the reported issue by improving code quality\n$FILE_CONTENT" > $FILE_PATH
            echo "Applied generic code improvement fix"
          fi
          
          # Mark as modified
          echo "modified_file=$FILE_PATH" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.count-upvotes.outputs.result == 'true'
        run: |
          git add ${{ steps.apply-fix.outputs.modified_file }}
          git commit -m "Fix: ${{ steps.get-issue.outputs.issue_title }} (#${{ steps.count-upvotes.outputs.issue_number }})"
          git push -u origin ${{ steps.create-fix-branch.outputs.branch_name }}

      - name: Create PR
        id: create-pr
        if: steps.count-upvotes.outputs.result == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const branchName = '${{ steps.create-fix-branch.outputs.branch_name }}';
            const issueNumber = ${{ steps.count-upvotes.outputs.issue_number }};
            
            console.log(`Creating PR for branch: ${branchName} and issue #${issueNumber}`);
            
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Fix: ${{ steps.get-issue.outputs.issue_title }}`,
              body: `AI-generated fix for issue #${issueNumber}\n\n${{ steps.get-issue.outputs.issue_body }}\n\nThis PR was automatically generated by the AI Issue Handler workflow.`,
              head: branchName,
              base: 'main'
            });
            
            console.log(`Created PR #${pullRequest.number}: ${pullRequest.html_url}`);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `I've created PR #${pullRequest.number} with an AI-generated fix for this issue: ${pullRequest.html_url}`
            });
            
            core.setOutput('pull_request_number', pullRequest.number.toString());

  merge-pr:
    runs-on: ubuntu-latest
    needs: handle-issue
    if: needs.handle-issue.outputs.result == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Count PR upvotes
        id: count-pr-upvotes
        uses: actions/github-script@v6
        with:
          script: |
            try {
              console.log('Context payload:', JSON.stringify(context.payload));
              
              // Handle both workflow dispatch and PR events
              let prNumber;
              if (context.payload.pull_request) {
                prNumber = context.payload.pull_request.number;
              } else if (context.payload.issue && context.payload.issue.pull_request) {
                prNumber = context.payload.issue.number;
              } else {
                // Get the latest PR from the previous job if called via workflow_dispatch
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  sort: 'created',
                  direction: 'desc',
                  per_page: 1
                });
                
                if (prs.length === 0) {
                  console.log('No open PRs found');
                  return false;
                }
                
                prNumber = prs[0].number;
              }
              
              console.log(`Checking upvotes for PR #${prNumber}`);
              
              // Get PR details including reactions
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              // Get PR issue to count reactions (PR reactions API is different)
              const { data: prIssue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });
              
              console.log(`PR reactions: ${JSON.stringify(prIssue.reactions)}`);
              
              // Count upvotes from reactions
              const upvotes = prIssue.reactions ? prIssue.reactions['+1'] : 0;
              
              // Also count upvotes from comments with ðŸ‘
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });
              
              // Count comments that contain ðŸ‘ or +1
              const commentsWithUpvotes = comments.filter(comment => 
                comment.body.includes('ðŸ‘') || 
                comment.body.includes(':+1:') || 
                /\+1\b/.test(comment.body)
              ).length;
              
              const totalUpvotes = upvotes + commentsWithUpvotes;
              const threshold = parseInt(process.env.MIN_UPVOTES || 1);
              
              console.log(`PR upvotes: ${totalUpvotes} (${upvotes} reactions + ${commentsWithUpvotes} comments), Threshold: ${threshold}`);
              
              const result = totalUpvotes >= threshold;
              core.setOutput('result', result.toString());
              core.setOutput('pr_number', prNumber.toString());
              
              return result;
            } catch (error) {
              console.log(`Error counting PR upvotes: ${error.stack}`);
              core.setFailed(`Error counting PR upvotes: ${error.message}`);
              return false;
            }

      - name: Merge PR
        if: steps.count-pr-upvotes.outputs.result == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const prNumber = steps.count-pr-upvotes.outputs.pr_number;
              
              console.log(`Merging PR #${prNumber}`);
              
              const { data: mergeResult } = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(prNumber),
                merge_method: 'merge',
                commit_title: `Merge PR #${prNumber}: AI-generated fix`,
                commit_message: `Automatically merging PR with AI-generated fix after receiving ${process.env.MIN_UPVOTES} upvotes.`
              });
              
              console.log(`Merge result: ${JSON.stringify(mergeResult)}`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber),
                body: `This PR has been automatically merged after receiving ${process.env.MIN_UPVOTES} upvotes.`
              });
              
            } catch (error) {
              console.log(`Error merging PR: ${error.stack}`);
              core.setFailed(`Error merging PR: ${error.message}`);
            }
